name: Auto-update theme via Pull Request

on:
  # Manual trigger when you push theme changes
  workflow_dispatch:

  # Optional: Daily check at 9am UTC (comment out if you prefer manual only)
  schedule:
    - cron: '0 9 * * *'

permissions:
  contents: write
  pull-requests: write

jobs:
  update-theme:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.3'

      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: '0.152.2'
          extended: true

      - name: Check for theme updates
        id: check
        run: |
          echo "Checking current theme version..."
          BEFORE=$(grep 'github.com/shawnyeager/tangerine-theme' go.mod | head -n1)
          echo "Current: $BEFORE"

          echo "Updating theme..."
          GOPROXY=direct hugo mod get -u github.com/shawnyeager/tangerine-theme
          hugo mod tidy

          AFTER=$(grep 'github.com/shawnyeager/tangerine-theme' go.mod | head -n1)
          echo "After update: $AFTER"

          if [ "$BEFORE" != "$AFTER" ]; then
            echo "Theme was updated!"
            echo "updated=true" >> $GITHUB_OUTPUT

            # Extract commit hash from end of version string
            HASH=$(echo "$AFTER" | grep -oP '[a-f0-9]{12}$')
            echo "hash=$HASH" >> $GITHUB_OUTPUT
          else
            echo "No theme updates available"
            echo "updated=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.check.outputs.updated == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: update tangerine-theme module"
          committer: "GitHub Actions <actions@github.com>"
          author: "GitHub Actions <actions@github.com>"
          branch: theme-update-${{ github.run_number }}
          delete-branch: true
          title: "Update tangerine-theme module"
          body: |
            ## Theme Update Available

            Auto-generated PR to update tangerine-theme module.

            **Commit:** `${{ steps.check.outputs.hash }}`

            ### Deploy Preview

            Netlify will automatically build a **FREE deploy preview** for this PR.
            Check the preview URL below before merging.

            ### Next Steps

            1. âœ… Wait for Netlify deploy preview to complete
            2. âœ… Review the preview URL
            3. âœ… Test site functionality
            4. âœ… Merge this PR when satisfied

            Merging will trigger ONE production build (15 credits).

            ---

            ðŸ¤– Generated by GitHub Actions
          labels: dependencies,automated,theme-update
