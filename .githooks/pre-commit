#!/bin/bash

# Pre-commit hook to auto-fix smart punctuation in markdown files
# Converts smart punctuation to plain ASCII so Hugo can handle typography

set -e

# Check if there are any staged markdown files
STAGED_MD_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.md$' || true)

if [ -z "$STAGED_MD_FILES" ]; then
  exit 0
fi

FIXED=false

echo "üîç Checking staged markdown files for smart punctuation..."

for file in $STAGED_MD_FILES; do
  if [ ! -f "$file" ]; then
    continue
  fi

  CHANGES=false

  # Check for curly apostrophes (U+2019)
  if grep -q $'\xe2\x80\x99' "$file"; then
    sed -i 's/\xe2\x80\x99/'\''/g' "$file"
    echo "  ‚úèÔ∏è  $file: Fixed curly apostrophes (') ‚Üí (')"
    CHANGES=true
  fi

  # Check for curly left single quote (U+2018)
  if grep -q $'\xe2\x80\x98' "$file"; then
    sed -i 's/\xe2\x80\x98/'\''/g' "$file"
    echo "  ‚úèÔ∏è  $file: Fixed curly left quotes (') ‚Üí (')"
    CHANGES=true
  fi

  # Check for curly left double quote (U+201C)
  if grep -q $'\xe2\x80\x9c' "$file"; then
    sed -i 's/\xe2\x80\x9c/"/g' "$file"
    echo "  ‚úèÔ∏è  $file: Fixed curly left quotes (\") ‚Üí (\")"
    CHANGES=true
  fi

  # Check for curly right double quote (U+201D)
  if grep -q $'\xe2\x80\x9d' "$file"; then
    sed -i 's/\xe2\x80\x9d/"/g' "$file"
    echo "  ‚úèÔ∏è  $file: Fixed curly right quotes (\") ‚Üí (\")"
    CHANGES=true
  fi

  # Check for em dash (U+2014)
  if grep -q $'\xe2\x80\x94' "$file"; then
    sed -i 's/\xe2\x80\x94/---/g' "$file"
    echo "  ‚úèÔ∏è  $file: Fixed em dashes (‚Äî) ‚Üí (---)"
    CHANGES=true
  fi

  # Check for en dash (U+2013)
  if grep -q $'\xe2\x80\x93' "$file"; then
    sed -i 's/\xe2\x80\x93/--/g' "$file"
    echo "  ‚úèÔ∏è  $file: Fixed en dashes (‚Äì) ‚Üí (--)"
    CHANGES=true
  fi

  # Check for ellipsis (U+2026)
  if grep -q $'\xe2\x80\xa6' "$file"; then
    sed -i 's/\xe2\x80\xa6/.../g' "$file"
    echo "  ‚úèÔ∏è  $file: Fixed ellipsis (‚Ä¶) ‚Üí (...)"
    CHANGES=true
  fi

  # Re-stage the file if it was modified
  if [ "$CHANGES" = true ]; then
    git add "$file"
    FIXED=true
  fi
done

if [ "$FIXED" = true ]; then
  echo ""
  echo "‚úÖ Auto-fixed smart punctuation. Changes have been staged."
  echo ""
fi

exit 0
